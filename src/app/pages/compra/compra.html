@if (queueState() !== 'allowed') {
  <app-waiting-room-card
    [state]="queueState()"
    [position]="queuePosition()"
    [errorMessage]="queueErrorMessage()"
    subtitle="Assim que sua vez chegar liberaremos a seleção de ingressos."
    footerNote="Reservamos sua tentativa de compra enquanto você permanece aqui."
    (refresh)="forceQueueRefresh()"
    (retry)="retryQueueAccess()"
  />
} @else {
  <div class="max-w-4xl mx-auto">
    <!-- Loading -->
    @if (loading()) {
      <div class="text-center py-12">
        <i class="pi pi-spin pi-spinner text-4xl text-primary-600 dark:text-primary-400"></i>
        <p class="mt-4 text-gray-600 dark:text-gray-400">Carregando evento...</p>
      </div>
    }

    <!-- Error -->
    @if (error() && !loading()) {
      <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 p-4 rounded-lg">
        <p class="text-red-800 dark:text-red-200">{{ error() }}</p>
        <p-button
          label="Voltar"
          icon="pi pi-arrow-left"
          styleClass="mt-4"
          (onClick)="voltar()"
        />
      </div>
    }

    <!-- Event Details and Purchase -->
    @if (!loading() && !error() && event()) {
      <div class="space-y-6">
        <!-- Event Info Card -->
        <p-card>
          <ng-template pTemplate="header">
            <img
              [alt]="event()!.name"
              [src]="event()!.bannerUrl"
              class="w-full h-64 object-cover"
            />
          </ng-template>

          <div class="space-y-3">
            <h1 class="text-3xl font-bold text-gray-900 dark:text-gray-100">{{ event()!.name }}</h1>

            <div class="flex items-start gap-2 text-gray-600 dark:text-gray-400">
              <i class="pi pi-map-marker mt-1"></i>
              <span>{{ event()!.location }}</span>
            </div>

            <div class="flex items-center gap-2 text-gray-600 dark:text-gray-400">
              <i class="pi pi-calendar"></i>
              <span>{{ event()!.startDate | date:'dd/MM/yyyy HH:mm' }}</span>
            </div>

            <p class="text-gray-700 dark:text-gray-300 mt-4">{{ event()!.description }}</p>

            <!-- Active Batch Info -->
            @if (event()?.activeBatch; as batch) {
              <div class="mt-4 p-4 bg-primary-50 dark:bg-primary-900/20 rounded-lg border border-primary-200 dark:border-primary-800">
                <h3 class="font-semibold text-primary-900 dark:text-primary-100 mb-2">
                  {{ batch.name }}
                </h3>
                <p class="text-sm text-primary-700 dark:text-primary-300">
                  Disponível até {{ batch.closingDate | date:'dd/MM/yyyy' }} ·
                  Máximo {{ batch.maxPerPurchase }} ingressos por compra
                </p>
                <div class="flex flex-wrap gap-3 mt-3">
                  @for (category of batch.categories; track category.id) {
                    <div class="text-xs px-3 py-1 rounded-full bg-white/70 dark:bg-primary-900/40 border border-primary-200 dark:border-primary-700">
                      {{ category.label }} · R$ {{ category.price }}
                    </div>
                  }
                </div>
              </div>
            }
          </div>
        </p-card>

        <!-- Ticket Selection Card -->
        @if (hasActiveBatch()) {
          <p-card>
            <ng-template pTemplate="header">
              <div class="p-4 border-b dark:border-dark-border">
                <h2 class="text-2xl font-bold text-gray-900 dark:text-gray-100">Selecione seus ingressos</h2>
                <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
                  Respeite o limite de {{ event()?.activeBatch?.maxPerPurchase ?? 0 }} ingressos por compra.
                </p>
              </div>
            </ng-template>

            <div class="space-y-6">
              @for (category of getActiveCategories(); track category.id) {
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 p-4 bg-gray-50 dark:bg-dark-hover rounded-lg">
                  <div class="flex-1 space-y-1">
                    <div class="flex items-center gap-2">
                      <h3 class="font-semibold text-gray-900 dark:text-gray-100">{{ category.label }}</h3>
                      <span class="text-xs px-2 py-1 rounded-full bg-gray-200 dark:bg-gray-800 text-gray-700 dark:text-gray-300">
                        {{ category.type }}
                      </span>
                    </div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">
                      R$ {{ category.price }}
                    </p>
                    <p class="text-xs text-gray-500 dark:text-gray-400">
                      Restam {{ category.remainingQuantity }} ingressos · Máx {{ category.maxPerPurchase }} por compra
                    </p>
                  </div>

                  <div class="flex items-center gap-3 self-start md:self-auto">
                    <p-button
                      icon="pi pi-minus"
                      [rounded]="true"
                      [outlined]="true"
                      severity="secondary"
                      (onClick)="decrementarCategoria(category)"
                      [disabled]="getQuantidadeCategoria(category.id) === 0"
                    />
                    <span class="text-xl font-bold text-gray-900 dark:text-gray-100 min-w-[2rem] text-center">
                      {{ getQuantidadeCategoria(category.id) }}
                    </span>
                    <p-button
                      icon="pi pi-plus"
                      [rounded]="true"
                      [outlined]="true"
                      severity="secondary"
                      (onClick)="incrementarCategoria(category)"
                      [disabled]="isIncrementDisabled(category)"
                    />
                  </div>
                </div>
              }
            </div>

            <ng-template pTemplate="footer">
              <div class="space-y-4">
                <!-- Total -->
                <div class="flex justify-between items-center p-4 bg-primary-50 dark:bg-primary-900/20 rounded-lg">
                  <div>
                    <p class="text-sm text-gray-600 dark:text-gray-400">Total de ingressos</p>
                    <p class="text-2xl font-bold text-gray-900 dark:text-gray-100">{{ getTotalIngressos() }}</p>
                  </div>
                  <div class="text-right">
                    <p class="text-sm text-gray-600 dark:text-gray-400">Valor total</p>
                    <p class="text-2xl font-bold text-primary-600 dark:text-primary-400">
                      R$ {{ calcularTotal().toFixed(2) }}
                    </p>
                  </div>
                </div>

                <!-- Action Buttons -->
                <div class="flex gap-3">
                  <p-button
                    label="Voltar"
                    icon="pi pi-arrow-left"
                    [outlined]="true"
                    styleClass="flex-1"
                    (onClick)="voltar()"
                  />
                  <p-button
                    label="Finalizar Compra"
                    icon="pi pi-check"
                    styleClass="flex-1"
                    [disabled]="!podeComprar()"
                    (onClick)="finalizar()"
                  />
                </div>
              </div>
            </ng-template>
          </p-card>
        } @else {
          <div class="p-6 bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg text-center">
            <h3 class="text-lg font-semibold text-yellow-900 dark:text-yellow-200">Ingressos indisponíveis</h3>
            <p class="text-sm text-yellow-800 dark:text-yellow-300 mt-2">
              No momento não há lote ativo para este evento. Volte mais tarde ou escolha outro evento.
            </p>
            <p-button
              label="Voltar para ingressos"
              icon="pi pi-arrow-left"
              styleClass="mt-4"
              (onClick)="voltar()"
            />
          </div>
        }
      </div>
    }
  </div>
}
